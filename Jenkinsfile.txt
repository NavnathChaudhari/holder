pipeline { 
         agent any  
         
           environment {
        jenkins_server_url = "http://192.168.152.130:8080"
        notification_channel = 'devops'
        slack_url = 'https://hooks.slack.com/services/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'
        
    }
         
    
    tools {
        maven 'maven3'
    }
    
    stages { 
        stage('Build Checkout') { 
            steps { 
              checkout([$class: 'GitSCM', branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/ckmine/holder.git']]])
         }
        }
        stage('Build Now') { 
            steps { 
              
                  dir("/var/lib/jenkins/workspace/mine-project") {
                    sh 'mvn -version'
                    sh 'mvn clean install'
                      
                    echo "build succses"
                }

       
              }

            }
            
            
            
             
              stage ('Code Quality scan') {
              steps {
       withSonarQubeEnv('sonar') {
          
       sh "mvn sonar:sonar -f /var/lib/jenkins/workspace/mine-project/pom.xml"
      
        }
   }
              }
              
              
              
              
              
              stage ('Vulnerability Scan - ') {
              steps {
                  
                 parallel   (
       "Dependency Scan": {
       	     	sh "mvn dependency-check:check"
		},
	 	  "Trivy Scan":{
	 		    sh "bash trivy-docker-image-scan.sh"
		     	},
		   "OPA Conftest":{
			sh 'docker run --rm -v $(pwd):/project openpolicyagent/conftest test --policy opa-docker-security.rego Dockerfile'
		    }   	
		             	
   	                      )
                    
              }
               }
              
           
              stage(' Rename and move Build To Perticuler Folder '){
                steps {
                   sh 'mv /var/lib/jenkins/workspace/mine-project/target/jenkins-git-integration.war   /var/lib/jenkins/workspace/mine-project/epps-smartERP.war'
                  sh 'chmod -R 777 /var/lib/jenkins/workspace/mine-project/epps-smartERP.war'
                  
                  sh 'chmod -R 777 /var/lib/jenkins/workspace/mine-project/Dockerfile'
                  sh 'chmod -R 777 /var/lib/jenkins/workspace/mine-project/shell.sh'
                  sh 'chown jenkins:jenkins  /var/lib/jenkins/workspace/mine-project/trivy-docker-image-scan.sh'                
                 
                                     }
                       }
                       
                       stage ("Slack-Notify"){
                         steps {
                            slackSend channel: 'devops', message: 'deployment successfully'
                         }
                       }

    stage ('Regitsry Approve') {
      steps {
      echo "Taking approval from DEV Manager forRegistry Push"
        timeout(time: 7, unit: 'DAYS') {
        input message: 'Do you want to deploy?', submitter: 'admin'
        }
      }
    }

 // Building Docker images
    stage('Building image | Upload to Harbor Repo') {
      steps{
            sh '/var/lib/jenkins/workspace/mine-project/shell.sh'  
    }
      
    }
    stage('Kuberneties Cluster Deployment') {
      steps
           {       
            sh 'cd /var/lib/jenkins/workspace/mine-project/ '
            sh 'ansible-playbook  /var/lib/jenkins/workspace/mine-project/test.yml'
      }
    }

                  
}

			 post{
                      always{
          
              dependencyCheckPublisher pattern: 'target/dependency-check-report.xml'
       }
   }

    }
